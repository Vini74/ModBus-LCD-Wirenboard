# Modbus LCD

Код для Arduino для работы с LCD экраном 4x20 с подключением по Modbus через RS485.

## Описание

Этот проект включает в себя:
1. Прошивку для Arduino Nano, управляющую LCD экраном через Modbus
2. Шаблон для WirenBoard для работы с LCD по Modbus

## Структура проекта

```
ModBus-LCD-Wirenboard/
├── src/
│   ├── main.cpp                    # Основная прошивка для Arduino Nano
│   └── TESTS/
│       └── UART_to_LCD.cpp         # Тестовый скетч для проверки LCD
├── platformio.ini                  # Конфигурация PlatformIO
├── Modbus_LCD_Register_Map.md      # Карта регистров Modbus
├── templates/
│   └── modbus_lcd.json             # Шаблон WirenBoard для устройства
├── doc/
│   └── modbus_templates.md         # Документация по шаблонам WirenBoard
└── README.md                       # Этот файл
```

## Установка и настройка Arduino

### Требования
- Arduino Nano
- LCD экран 4x20 с I2C адаптером
- RS485 to UART преобразователь

### Сборка и загрузка прошивки
Для сборки и загрузки прошивки используется PlatformIO. Проект уже настроен для работы с Arduino Nano.

### Тестирование подключения LCD
В проекте имеется тестовый скетч для проверки работы LCD экрана:
- `src/TESTS/UART_to_LCD.cpp` - тестовый скетч, который принимает данные через UART и отображает их на LCD экране

Для тестирования:
1. Загрузите тестовый скетч на Arduino Nano
2. Откройте монитор последовательного порта
3. Введите текст и нажмите Enter - он должен отобразиться на LCD экране

## Карта регистров Modbus

### Буфер кадра экрана (регистры 0-99)
- Каждый регистр содержит 2 символа: старший байт (первый символ) и младший байт (второй символ)
- При изменении содержимого регистров 0-99 содержимое экрана автоматически обновляется

### Системная информация (регистры 100-109)
| Адрес | Назначение | Формат данных | Описание |
|-------|------------|---------------|----------|
| 100 | Версия прошивки | UINT16 | Версия прошивки устройства |
| 101 | Статус устройства | UINT16 | 1 - готов, 0 - не готов |
| 102 | Ошибки устройства | UINT16 | Код ошибки устройства (0 - нет ошибок) |
| 103 | Текущий адрес Modbus | UINT16 | Текущий адрес устройства |
| 104 | Текущая скорость Modbus | UINT16 | Текущая скорость обмена (в сотнях бод) |
| 105-109 | Зарезервировано | UINT16 | Для будущего использования |

### Управление экраном (регистры 110-119)
| Адрес | Назначение | Формат данных | Описание |
|-------|------------|---------------|----------|
| 110 | Команда очистки экрана | UINT16 | 1 - очистить экран, 0 - нет команды |
| 111 | Статус выполнения очистки экрана | UINT16 | 1 - выполнено, 0 - ожидание, 2 - ошибка |
| 112 | Включение/выключение отображения | UINT16 | 1 - включить отображение, 0 - выключить отображение |

## Конфигурация устройства

### Настройка адреса Modbus и скорости обмена
Устройство поддерживает настройку адреса Modbus и скорости обмена через джамперы, подключенные к входам Arduino. Входы подтянуты к +5В через резисторы, а джамперы замыкают их на землю для установки определенных битов конфигурации.

#### Адрес Modbus (биты 0-3)
- 4 входа (D2-D5) используются для установки адреса устройства (1-16)
- Замыкание входа на землю устанавливает соответствующий бит в 0
- По умолчанию все биты установлены в 1 (адрес 16)

#### Скорость обмена (биты 4-5)
- 2 входа (D6-D7) используются для выбора скорости обмена:
  - 00: 9600 бод (по умолчанию, когда джамперы не установлены)
  - 01: 19200 бод
  - 10: 57600 бод
  - 11: 115200 бод

## Интеграция с WirenBoard

### Шаблон устройства
В проект включен шаблон для интеграции с контроллерами WirenBoard:
- `templates/modbus_lcd.json` - шаблон устройства для wb-mqtt-serial

Шаблон определяет следующие каналы:
- Строковые каналы для управления текстом на каждой строке дисплея (String_1, String_2, String_3, String_4)
- Канал для очистки экрана (Clear Screen)
- Канал для отслеживания статуса очистки экрана (Clear Screen Status)
- Канал для включения/выключения отображения (Display Enable)

### Установка шаблона
1. Скопируйте файл `templates/modbus_lcd.json` в директорию `/etc/wb-mqtt-serial.conf.d/templates/` на вашем контроллере WirenBoard
2. Перезапустите сервис wb-mqtt-serial: `systemctl restart wb-mqtt-serial`
3. Настройте устройство через веб-интерфейс контроллера WirenBoard, выбрав тип устройства "Modbus LCD"